<!DOCTYPE html>
<html>
<head>
    <title>üß™ Bumba Fresh API Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .loading { background: #fff3cd; border-color: #ffeaa7; }
        button { background: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .status { font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Bumba Fresh API Connection Test</h1>
        
        <div id="backend-test" class="test-section loading">
            <h3>1. Backend Connection Test</h3>
            <p>Testing backend server at http://localhost:8000...</p>
            <button onclick="testBackend()">Test Backend</button>
            <pre id="backend-result">Click 'Test Backend' to start...</pre>
        </div>

        <div id="database-test" class="test-section loading">
            <h3>2. Database Connection Test</h3>
            <p>Testing database through backend API...</p>
            <button onclick="testDatabase()">Test Database</button>
            <pre id="database-result">Click 'Test Database' to start...</pre>
        </div>

        <div id="registration-test" class="test-section loading">
            <h3>3. Registration Test</h3>
            <p>Testing user registration:</p>
            <input type="email" id="reg-email" placeholder="Email" value="">
            <input type="password" id="reg-password" placeholder="Password" value="TestPassword123">
            <input type="text" id="reg-firstname" placeholder="First Name" value="Test">
            <input type="text" id="reg-lastname" placeholder="Last Name" value="User">
            <br>
            <button onclick="generateTestEmail()">Generate Test Email</button>
            <button onclick="testRegistration()">Test Registration</button>
            <pre id="registration-result">Click 'Generate Test Email' then 'Test Registration'...</pre>
        </div>

        <div id="login-test" class="test-section loading">
            <h3>4. Login Test</h3>
            <p>Test login with existing account:</p>
            <input type="email" id="login-email" placeholder="admin@gmail.com" value="admin@gmail.com">
            <input type="password" id="login-password" placeholder="password" value="password123">
            <br>
            <button onclick="testAdminLogin()">Test Admin Login</button>
            <button onclick="testLoginWithNewAccount()">Login with Test Account</button>
            <pre id="login-result">Test admin login or create account first...</pre>
        </div>

        <div id="summary" class="test-section loading">
            <h3>üìä Test Summary</h3>
            <ul id="summary-list">
                <li>‚è≥ Tests not started yet</li>
            </ul>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let authToken = null;
        let testResults = {
            backend: false,
            database: false,
            registration: false,
            login: false
        };

        function generateTestEmail() {
            const timestamp = Date.now();
            document.getElementById('reg-email').value = `test${timestamp}@example.com`;
        }

        function updateSummary() {
            const list = document.getElementById('summary-list');
            const results = Object.entries(testResults);
            const passed = results.filter(([_, status]) => status === true).length;
            const total = results.length;
            
            list.innerHTML = results.map(([test, status]) => 
                `<li>${status ? '‚úÖ' : '‚ùå'} ${test.charAt(0).toUpperCase() + test.slice(1)}: ${status ? 'PASSED' : 'FAILED'}</li>`
            ).join('') + `<li><strong>Overall: ${passed}/${total} tests passed</strong></li>`;
            
            const summaryDiv = document.getElementById('summary');
            summaryDiv.className = `test-section ${passed === total ? 'success' : 'error'}`;
        }

        async function makeRequest(url, options = {}) {
            try {
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };

                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                const response = await fetch(url, {
                    ...options,
                    headers
                });

                const data = await response.json();
                return {
                    status: response.status,
                    ok: response.ok,
                    data
                };
            } catch (error) {
                return {
                    status: 0,
                    ok: false,
                    data: { error: error.message }
                };
            }
        }

        async function testBackend() {
            const result = document.getElementById('backend-result');
            const container = document.getElementById('backend-test');
            
            result.textContent = 'Testing...';
            container.className = 'test-section loading';
            
            // Test health endpoint
            const healthResponse = await makeRequest(`${API_URL}/health`);
            
            if (healthResponse.ok) {
                container.className = 'test-section success';
                result.textContent = `‚úÖ Backend Connected!\n${JSON.stringify(healthResponse.data, null, 2)}`;
                testResults.backend = true;
            } else {
                container.className = 'test-section error';
                result.textContent = `‚ùå Backend Connection Failed!\nStatus: ${healthResponse.status}\n${JSON.stringify(healthResponse.data, null, 2)}`;
                testResults.backend = false;
            }
            updateSummary();
        }

        async function testDatabase() {
            const result = document.getElementById('database-result');
            const container = document.getElementById('database-test');
            
            result.textContent = 'Testing database connection...';
            container.className = 'test-section loading';
            
            // Test a simple API endpoint that uses the database
            const mealsResponse = await makeRequest(`${API_URL}/api/meals`);
            
            if (mealsResponse.ok) {
                container.className = 'test-section success';
                result.textContent = `‚úÖ Database Connected!\n${JSON.stringify(mealsResponse.data, null, 2)}`;
                testResults.database = true;
            } else {
                container.className = 'test-section error';
                result.textContent = `‚ùå Database Connection Failed!\nStatus: ${mealsResponse.status}\n${JSON.stringify(mealsResponse.data, null, 2)}`;
                testResults.database = false;
            }
            updateSummary();
        }

        async function testRegistration() {
            const result = document.getElementById('registration-result');
            const container = document.getElementById('registration-test');
            
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const firstName = document.getElementById('reg-firstname').value;
            const lastName = document.getElementById('reg-lastname').value;
            
            if (!email) {
                result.textContent = '‚ùå Please generate a test email first';
                return;
            }
            
            result.textContent = 'Testing registration...';
            container.className = 'test-section loading';
            
            const registerResponse = await makeRequest(`${API_URL}/api/auth/register`, {
                method: 'POST',
                body: JSON.stringify({
                    email,
                    password,
                    firstName,
                    lastName
                })
            });
            
            if (registerResponse.ok) {
                container.className = 'test-section success';
                authToken = registerResponse.data.token;
                result.textContent = `‚úÖ Registration Successful!\nUser: ${registerResponse.data.user.email}\nToken received: ${authToken ? 'Yes' : 'No'}`;
                testResults.registration = true;
            } else {
                container.className = 'test-section error';
                result.textContent = `‚ùå Registration Failed!\nStatus: ${registerResponse.status}\n${JSON.stringify(registerResponse.data, null, 2)}`;
                testResults.registration = false;
            }
            updateSummary();
        }

        async function testAdminLogin() {
            const result = document.getElementById('login-result');
            const container = document.getElementById('login-test');
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            result.textContent = 'Testing admin login...';
            container.className = 'test-section loading';
            
            const loginResponse = await makeRequest(`${API_URL}/api/auth/login`, {
                method: 'POST',
                body: JSON.stringify({
                    email,
                    password
                })
            });
            
            if (loginResponse.ok) {
                container.className = 'test-section success';
                authToken = loginResponse.data.token;
                result.textContent = `‚úÖ Admin Login Successful!\nUser: ${loginResponse.data.user.email}\nToken received: ${authToken ? 'Yes' : 'No'}`;
                testResults.login = true;
            } else {
                container.className = 'test-section error';
                result.textContent = `‚ùå Admin Login Failed!\nStatus: ${loginResponse.status}\n${JSON.stringify(loginResponse.data, null, 2)}`;
                testResults.login = false;
            }
            updateSummary();
        }

        async function testLoginWithNewAccount() {
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            
            if (!email) {
                alert('Please create a test account first');
                return;
            }
            
            document.getElementById('login-email').value = email;
            document.getElementById('login-password').value = password;
            
            await testAdminLogin();
        }

        // Auto-run backend test on page load
        window.onload = function() {
            generateTestEmail();
            testBackend();
        };
    </script>
</body>
</html>
